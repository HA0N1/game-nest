<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Application</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div>
      <h2>채팅방 목록</h2>
      <ul id="rooms"></ul>
    </div>

    <div id="chat">Chat</div>

    <input type="text" id="message" placeholder="메시지 입력" />
    <button onclick="sendMessage()">전송</button>
    <button onclick="createRoom()">채팅 만들기</button>

    <div>
      <h2>공지</h2>
      <div id="notice"></div>
    </div>

    <script src="http://code.jquery.com/jquery-3.6.1.slim.js"></script>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>

    <script>
      const token = document.cookie;
      const roomSocket = io('http://localhost:3000/room', { auth: { token: token } });
      let currentRoom = '';
      const nickname = prompt('닉네임');

      function sendMessage() {
        if (currentRoom === '') {
          alert('방을 선택해주세요');
          return;
        }
        const message = $('#message').val();
        const data = { message, nickname, room: currentRoom };
        $('#chat').append(`<div>나:${message}</div>`);
        roomSocket.emit('message', data);
        return false;
      }

      function createRoom() {
        const room = prompt('방이름');
        const chatType = prompt('채팅 타입');
        const maximumPeople = prompt('최대 인원');
        const channelId = prompt('채널');
        roomSocket.emit('createRoom', {
          room,
          nickname,
          createChatDto: { title: room, chatType, maximumPeople, channelId },
        });
      }

      roomSocket.on('roomCreated', function (data) {
        roomSocket.emit('requestRooms');
      });

      roomSocket.on('notice', data => {
        $('#notice').append(`<div>${data.message}</div>`);
      });

      roomSocket.on('message', data => {
        $('#chat').append(`<div>${data.message}</div>`);
      });

      $(document).ready(function () {
        roomSocket.emit('requestRooms');

        roomSocket.on('rooms', function (data) {
          updateRoomList(data);
        });
      });

      function updateRoomList(rooms) {
        $('#rooms').empty();
        rooms.forEach(room => {
          $('#rooms').append(`<li>${room.title} <button onclick="joinRoom('${room.title}')">join</button></li>`);
        });
      }
      function joinRoom(room) {
        roomSocket.emit('joinRoom', { room });
        $('#chat').html('');
        currentRoom = room;
        roomSocket.emit('requestChatHistory', { room });
      }

      roomSocket.on('connect', () => {
        console.log('connected', roomSocket.id);
      });

      roomSocket.on('dmHistory', function (dms) {
        $('#chat').html('');
        dms.forEach(dm => {
          // 각 메시지의 발신자 닉네임을 사용하여 표시
          $('#chat').append(`<div>${dm.senderNickname}: ${dm.content}</div>`);
        });
      });
    </script>
  </body>
</html>
